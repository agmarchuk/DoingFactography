@using RDFEngine
@inject OAData.IFactographDataService db

<div>
    <input @bind="searchsample" style="height:24px; margin-top:0px;margin-bottom:10px;" />
    <select @bind="searchtype" style="height:24px; margin-top:0px;margin-bottom:10px;">
        <option value=""></option>
        @foreach (var typ in typs.Where(t => RDFEngine.Infobase.rontology.LabelOfOnto(t) != null)) //TODO: Надо бы более корректно...
        {
            <option value="@typ">@(RDFEngine.Infobase.rontology.LabelOfOnto(typ))</option>
        }
    </select>
    <span>расш.<input type="checkbox" @bind="extended" /></span>
</div>
@if (!string.IsNullOrEmpty(searchsample))
{
    IEnumerable<RRecord> query = null;
    if (!extended)
    {
        query = (new RDFEngine.RYEngine(db) { User = user }).RSearch(searchsample);
    }
    else
    {
        query = (new RDFEngine.RYEngine(db) { User = user }).RSearchByWords(searchsample);
    }


    if (string.IsNullOrEmpty(searchtype)) query = query.Where(r => typs.Contains(r.Tp));
    else query = query.Where(r => r.Tp == searchtype);
    // Убрать дубли
    query = query.Distinct(new RRecordComparer());
    if (!extended) { query = query.OrderBy(r => RDFEngine.Infobase.GetName(r)); }
    bool nothing = true;
    foreach (RRecord rec in query)
    {
        nothing = false;
        <div>
            <a href="javascript:void(0)" @onclick="@(e =>SearchResultClick(rec))">@RDFEngine.Infobase.GetName(rec)</a>
            <span style="color:red;">@(RDFEngine.Infobase.rontology.LabelOfOnto(rec.Tp))</span>
        </div>
    }
    if (nothing)
    {
        <div>Ничего не найдено</div>
    }
    if (toedit && !string.IsNullOrEmpty(searchtype))
    {
        <div><a href="javascript:void(0)" @onclick="@(e =>NewItemClick(searchtype))">нов.</a></div>
    }
}

@code{
    [Parameter]
    public EventCallback onSelected { get; set; }
    [Parameter]
    public string searchsample { get; set; }
    [Parameter]
    public string[] typs { get; set; }
    [Parameter]
    public string user { get; set; }
    private bool toedit { get { return !string.IsNullOrEmpty(user); } }
    private bool extended = false;

    private async Task SearchResultClick(RRecord rec)
    {
        searchsample = null;
        extended = false;
        await onSelected.InvokeAsync(rec.Id);
    }
    private async Task NewItemClick(string tp)
    {
        string nid = (new RDFEngine.RYEngine(db) { User = user }).NewRecord(searchtype, searchsample);
        searchsample = null;
        await onSelected.InvokeAsync(nid);
    }
    private string searchtype;
}
